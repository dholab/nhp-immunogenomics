name: Process Provisional Changes

# Triggered by the NHP Immunogenomics macOS app after staging files on a branch.
# If .staging/config.json exists: runs provisional-add with the staged FASTA, then cleans up.
# Always runs provisional-build to regenerate GenBank files and metadata index.

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Parse staging config
        id: config
        if: hashFiles('.staging/config.json') != ''
        run: |
          python3 -c "
          import json, os
          cfg = json.load(open('.staging/config.json'))
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              for key in ('species', 'locus', 'allele_class', 'seq_type', 'submitter', 'notes'):
                  f.write(f'{key}={cfg[key]}\n')
          "

      - name: Add provisional allele(s)
        if: steps.config.outcome == 'success'
        run: |
          uv run nhp-pipeline provisional-add \
            --species "${{ steps.config.outputs.species }}" \
            --locus "${{ steps.config.outputs.locus }}" \
            --class "${{ steps.config.outputs.allele_class }}" \
            --seq-type "${{ steps.config.outputs.seq_type }}" \
            --submitter "${{ steps.config.outputs.submitter }}" \
            --notes "${{ steps.config.outputs.notes }}" \
            --fasta .staging/input.fasta

          rm -rf .staging

      - name: Build provisional GenBank files and update metadata index
        run: uv run nhp-pipeline provisional-build

      - name: Summarize changes
        id: summary
        run: |
          added=$(git diff --unified=0 provisional/manifest.tsv 2>/dev/null | grep '^+[^+]' | grep -v '^+name' | wc -l | tr -d ' ')
          echo "count=${added:-0}" >> "$GITHUB_OUTPUT"
          species="${{ steps.config.outputs.species }}"
          locus="${{ steps.config.outputs.locus }}"
          if [ -n "$species" ] && [ -n "$locus" ]; then
            echo "label=${species}-${locus}" >> "$GITHUB_OUTPUT"
          else
            echo "label=provisional" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "Process ${{ steps.summary.outputs.label }}: ${{ steps.summary.outputs.count }} allele(s)"
          git push

      - name: Auto-merge PR and trigger deploy
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr ready "$PR_NUMBER" 2>/dev/null || true
            gh pr merge "$PR_NUMBER" --squash --delete-branch

            # GITHUB_TOKEN merges don't trigger push-based workflows,
            # so explicitly dispatch the deploy.
            gh workflow run "Deploy Pages" --ref main
          fi
        env:
          GH_TOKEN: ${{ github.token }}
